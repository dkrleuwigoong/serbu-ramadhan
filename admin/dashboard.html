<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Serbu Ramadhan</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-light bg-white shadow-sm px-3">
        <div class="d-flex align-items-center">
            <!-- Hamburger -->
            <button class="btn" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                <i class="bi bi-list fs-4"></i>
            </button>
            <span class="navbar-brand mb-0 h5 ms-2">Serbu Ramadhan</span>
        </div>

        <!-- Right Side -->
        <div class="d-flex align-items-center gap-3">
            <a href="akun.html" class="text-secondary">
                <i class="bi bi-person-circle fs-2"></i>
            </a>
            <a href="../login-admin.html" class="text-secondary">
                <i class="bi bi-box-arrow-right fs-2"></i>
            </a>
        </div>

    </nav>

    <!-- SIDEBAR OFFCANVAS -->
    <div class="offcanvas offcanvas-start" tabindex="-2" id="sidebarMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>

        <div class="offcanvas-body">
            <ul class="nav flex-column gap-2">
                <li class="nav-item">
                    <a class="nav-link sidebar-link active bg-light" href="dashboard.html">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link sidebar-link" href="data-peserta.html">
                        <i class="bi bi-people me-2"></i> Data Peserta
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link sidebar-link" href="kode-voting.html">
                        <i class="bi bi-key me-2"></i> Kode Voting
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link sidebar-link" href="hasil-voting.html">
                        <i class="bi bi-bar-chart me-2"></i> Hasil Voting
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="container-fluid mt-4 px-3">
        <div class="row g-4">

            <!-- Total Peserta -->
            <div class="col-md-4">
                <div class="dashboard-card card-peserta">
                    <div class="card-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div>
                        <h6>Total Peserta</h6>
                        <h2 id="totalPeserta">0</h2>
                    </div>
                </div>
            </div>

            <!-- Total Vote -->
            <div class="col-md-4">
                <div class="dashboard-card card-vote">
                    <div class="card-icon">
                        <i class="bi bi-bar-chart-fill"></i>
                    </div>
                    <div>
                        <h6>Total Vote</h6>
                        <h2 id="totalVote">0</h2>
                    </div>
                </div>
            </div>

            <!-- Sisa Kode -->
            <div class="col-md-4">
                <div class="dashboard-card card-kode">
                    <div class="card-icon">
                        <i class="bi bi-key-fill"></i>
                    </div>
                    <div>
                        <h6>Sisa Kode Voting</h6>
                        <h2 id="sisaKode">0</h2>
                    </div>
                </div>
            </div>

        </div>

        <div class="voting-chart-card mt-4">

            <!-- Header -->
            <div class="chart-header">
                <div class="d-flex align-items-center gap-2">
                    <div class="chart-icon">
                        <i class="bi bi-bar-chart-line-fill"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Grafik Hasil Voting</h5>
                        <small class="text-muted">Statistik perolehan suara peserta</small>
                    </div>
                </div>

                <span class="badge bg-primary">Live Data</span>
            </div>

            <!-- Chart -->
            <div class="chart-body">
                <canvas id="grafikVoting"></canvas>
            </div>

        </div>


        <div class="kategori-chart-card mt-4 mb-4">

            <!-- Header -->
            <div class="chart-header">
                <div class="d-flex align-items-center gap-3">
                    <div class="chart-icon">
                        <i class="bi bi-pie-chart-fill"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Voting Per Kategori</h5>
                        <small class="text-muted">Distribusi suara berdasarkan kategori lomba</small>
                    </div>
                </div>

                <span class="badge bg-success">Analytics</span>
            </div>

            <!-- Chart Body -->
            <div class="chart-body">
                <canvas id="grafikKategori"></canvas>
            </div>

        </div>


    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function updateTotalPeserta() {
            let peserta = JSON.parse(localStorage.getItem("peserta")) || [];
            document.getElementById("totalPeserta").innerText = peserta.length;
        }

        updateTotalPeserta();

        function updateTotalVote() {
            let kodeVoting = JSON.parse(localStorage.getItem("kodeVoting")) || [];
            let totalVote = kodeVoting.filter(k => k.status === "Sudah Dipakai").length;
            document.getElementById("totalVote").innerText = totalVote;
        }

        updateTotalVote();

        function updateSisaKode() {
            let kodeVoting = JSON.parse(localStorage.getItem("kodeVoting")) || [];

            // Hitung yang belum dipakai
            let sisa = kodeVoting.filter(k => k.status !== "Sudah Dipakai").length;

            document.getElementById("sisaKode").innerText = sisa;
        }

        document.addEventListener("DOMContentLoaded", function () {
            updateSisaKode();
        });

        function animateCounter(id, end) {
            let start = 0;
            let duration = 500;
            let stepTime = Math.abs(Math.floor(duration / end));
            let obj = document.getElementById(id);

            let timer = setInterval(function () {
                start++;
                obj.innerText = start;
                if (start >= end) clearInterval(timer);
            }, stepTime);
        }

        function updateSisaKode() {
            let kodeVoting = JSON.parse(localStorage.getItem("kodeVoting")) || [];
            let sisa = kodeVoting.filter(k => k.status !== "Sudah Dipakai").length;
            animateCounter("sisaKode", sisa);
        }

        function loadGrafik() {
            let peserta = JSON.parse(localStorage.getItem("peserta")) || [];

            let labels = peserta.map(p => p.nama);
            let votes = peserta.map(p => parseInt(p.vote) || 0);

            const ctx = document.getElementById('grafikVoting').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Vote',
                        data: votes,
                        borderRadius: 8,
                        backgroundColor: [
                            '#6a11cb',
                            '#2575fc',
                            '#ff512f',
                            '#dd2476',
                            '#11998e',
                            '#38ef7d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#eee'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener("DOMContentLoaded", loadGrafik);

        function loadGrafikKategori() {

            let peserta = JSON.parse(localStorage.getItem("peserta")) || [];

            // Hitung total vote per kategori
            let kategoriMap = {};

            peserta.forEach(p => {
                let kategori = p.kategori;
                let vote = parseInt(p.vote) || 0;

                if (!kategoriMap[kategori]) {
                    kategoriMap[kategori] = 0;
                }

                kategoriMap[kategori] += vote;
            });

            let labels = Object.keys(kategoriMap);
            let data = Object.values(kategoriMap);

            const ctx = document.getElementById('grafikKategori').getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderWidth: 2,
                        borderColor: "#ffffff",
                        backgroundColor: [
                            "#8e2de2",
                            "#ff4fd8",
                            "#2575fc",
                            "#38ef7d",
                            "#ff512f",
                            "#11998e"
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    cutout: "60%",
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener("DOMContentLoaded", loadGrafikKategori);
    </script>
</body>

</html>