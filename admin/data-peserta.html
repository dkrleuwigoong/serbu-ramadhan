<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Data Peserta - Serbu Ramadhan</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">

    <style>
        .sidebar-link {
            text-decoration: none;
            color: #212529;
            padding: 8px;
            border-radius: 8px;
        }

        .sidebar-link:hover {
            background-color: #f1f1f1;
        }

        .offcanvas {
            max-width: 250px;
        }

        .table-custom-small th,
        .table-custom-small td {
            font-size: 12px;
            padding: 6px;
        }

        .table-custom-small {
            width: 100% !important;
            table-layout: auto;
        }

        .card {
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-light bg-white shadow-sm px-3">
        <div class="d-flex align-items-center">
            <!-- Hamburger -->
            <button class="btn" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                <i class="bi bi-list fs-4"></i>
            </button>
            <span class="navbar-brand mb-0 h5 ms-2">Serbu Ramadhan</span>
        </div>

        <!-- Right Side -->
        <div class="d-flex align-items-center gap-3">
            <a href="akun.html" class="text-secondary">
                <i class="bi bi-person-circle fs-2"></i>
            </a>
            <a href="../login-admin.html" class="text-secondary">
                <i class="bi bi-box-arrow-right fs-2"></i>
            </a>
        </div>
    </nav>

    <!-- SIDEBAR OFFCANVAS -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>

        <div class="offcanvas-body">
            <ul class="nav flex-column gap-2">
                <li class="nav-item">
                    <a class="nav-link sidebar-link" href="dashboard.html">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link sidebar-link active bg-light" href="data-peserta.html">
                        <i class="bi bi-people me-2"></i> Data Peserta
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link sidebar-link" href="kode-voting.html">
                        <i class="bi bi-key me-2"></i> Kode Voting
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link sidebar-link" href="hasil-voting.html">
                        <i class="bi bi-bar-chart me-2"></i> Hasil Voting
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="container-fluid mt-4 px-3">

        <!-- Header + Button -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 fw-semibold">Daftar Peserta</h6>

            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">

                <!-- FILTER -->
                <div class="btn-group flex-wrap" role="group" name="filter" aria-label="Filter Kategori">
                    <input type="radio" class="btn-check" name="filter" id="semua" autocomplete="off" checked>
                    <label class="btn btn-outline-primary btn-sm" for="semua">Semua</label>

                    <input type="radio" class="btn-check" name="filter" id="pidato" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="pidato">Pidato</label>

                    <input type="radio" class="btn-check" name="filter" id="nasyid" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="nasyid">Nasyid</label>

                    <input type="radio" class="btn-check" name="filter" id="kaligrafi" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="kaligrafi">Kaligrafi</label>

                    <input type="radio" class="btn-check" name="filter" id="vlog" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="vlog">Vlog</label>

                    <input type="radio" class="btn-check" name="filter" id="poster" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="poster">Poster</label>

                    <input type="radio" class="btn-check" name="filter" id="essai" autocomplete="off">
                    <label class="btn btn-outline-primary btn-sm" for="essai">Essai</label>
                </div>

                <!-- ACTION BUTTON -->
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="downloadPDF()">
                        <i class="bi bi-download me-1"></i> Unduh
                    </button>

                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTambahPeserta">
                        <i class="bi bi-plus-circle me-1"></i> Tambah
                    </button>
                </div>

            </div>
        </div>

        <!-- Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle table-custom-small w-100">
                        <thead class="table-light text-center">
                            <tr>
                                <th width="5%">No</th>
                                <th>Nomor Peserta</th>
                                <th>Nama Peserta</th>
                                <th>Jenis Kelamin</th>
                                <th>Pangkalan</th>
                                <th>Kwarran</th>
                                <th>Kategori</th>
                                <th width="15%" class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabelPeserta">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
    <!-- MODAL TAMBAH PESERTA -->
    <div class="modal fade" id="modalTambahPeserta" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus me-2"></i>Tambah Peserta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="formPeserta">
                        <div class="row g-3">

                            <div class="col-md-6">
                                <label class="form-label">Nomor Peserta</label>
                                <input type="text" class="form-control" id="nomor" readonly>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Nama Peserta</label>
                                <input type="text" class="form-control text-uppercase" name="nama"
                                    oninput="this.value = this.value.toUpperCase()">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Jenis Kelamin</label>
                                <select class="form-select" name="jk" required>
                                    <option value="">Pilih</option>
                                    <option>Laki-laki</option>
                                    <option>Perempuan</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Pangkalan</label>
                                <input type="text" class="form-control text-uppercase" name="pangkalan"
                                    oninput="this.value = this.value.toUpperCase()">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Kwarran (Kecamatan)</label>
                                <select class="form-select" name="kwarran" required>
                                    <option value="">Pilih Kecamatan</option>
                                    <option>Banjarwangi</option>
                                    <option>Banyuresmi</option>
                                    <option>Bayongbong</option>
                                    <option>Blubur Limbangan</option>
                                    <option>Bungbulang</option>
                                    <option>Caringin</option>
                                    <option>Cibalong</option>
                                    <option>Cibatu</option>
                                    <option>Cibiuk</option>
                                    <option>Cigedug</option>
                                    <option>Cihurip</option>
                                    <option>Cikajang</option>
                                    <option>Cikelet</option>
                                    <option>Cilawu</option>
                                    <option>Cisewu</option>
                                    <option>Cisompet</option>
                                    <option>Cisurupan</option>
                                    <option>Garut Kota</option>
                                    <option>Kadungora</option>
                                    <option>Karangpawitan</option>
                                    <option>Karangtengah</option>
                                    <option>Kersamanah</option>
                                    <option>Leles</option>
                                    <option>Leuwigoong</option>
                                    <option>Malangbong</option>
                                    <option>Mekarmukti</option>
                                    <option>Pakenjeng</option>
                                    <option>Pameungpeuk</option>
                                    <option>Pamulihan</option>
                                    <option>Pangatikan</option>
                                    <option>Pasirwangi</option>
                                    <option>Peundeuy</option>
                                    <option>Samarang</option>
                                    <option>Selaawi</option>
                                    <option>Singajaya</option>
                                    <option>Sucinaraja</option>
                                    <option>Sukaresmi</option>
                                    <option>Sukawening</option>
                                    <option>Talegong</option>
                                    <option>Tarogong Kaler</option>
                                    <option>Tarogong Kidul</option>
                                    <option>Wanaraja</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Kategori</label>
                                <select id="kategori" class="form-select">
                                    <option value="">Pilih Kategori</option>
                                    <option value="Pidato">Pidato</option>
                                    <option value="Kaligrafi">Kaligrafi</option>
                                    <option value="Nasyid">Nasyid</option>
                                    <option value="Vlog">Vlog</option>
                                    <option value="Poster">Poster</option>
                                    <option value="Essai">Essai</option>
                                </select>

                            </div>

                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" form="formPeserta" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        let editIndex = null;
        document.addEventListener("DOMContentLoaded", function () {

            const form = document.getElementById("formPeserta");
            const tabel = document.getElementById("tabelPeserta");

            // Ambil data dari LocalStorage saat halaman dibuka
            tampilkanData();

            form.addEventListener("submit", function (e) {
                e.preventDefault();

                const data = {
                    nomor: form.nomor.value,
                    nama: form.nama.value,
                    jk: form.jk.value,
                    pangkalan: form.pangkalan.value,
                    kwarran: form.kwarran.value,
                    kategori: form.kategori.value
                };

                let peserta = JSON.parse(localStorage.getItem("peserta")) || [];

                if (editIndex !== null) {
                    peserta[editIndex] = data;
                    editIndex = null;
                } else {
                    peserta.push(data);
                }

                localStorage.setItem("peserta", JSON.stringify(peserta));

                form.reset();
                bootstrap.Modal.getInstance(document.getElementById('modalTambahPeserta')).hide();
                tampilkanData();
            });

            window.editData = function (index) {
                let peserta = JSON.parse(localStorage.getItem("peserta")) || [];
                let data = peserta[index];

                form.nomor.value = data.nomor;
                form.nama.value = data.nama;
                form.jk.value = data.jk;
                form.pangkalan.value = data.pangkalan;
                form.kwarran.value = data.kwarran;
                form.kategori.value = data.kategori;

                editIndex = index;

                const modal = new bootstrap.Modal(document.getElementById('modalTambahPeserta'));
                modal.show();
            };

            function tampilkanData() {
                tabel.innerHTML = "";
                let peserta = JSON.parse(localStorage.getItem("peserta")) || [];

                if (peserta.length === 0) {
                    tabel.innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center text-muted">Belum ada data</td>
                    </tr>
                `;
                    return;
                }

                peserta.forEach((item, index) => {
                    tabel.innerHTML += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>${item.nomor}</td>
                        <td>${item.nama}</td>
                        <td>${item.jk}</td>
                        <td>${item.pangkalan}</td>
                        <td>${item.kwarran}</td>
                        <td>${item.kategori}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-warning me-1" onclick="editData(${indexAsli})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="hapusData(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                });
            }

            window.hapusData = function (index) {
                let peserta = JSON.parse(localStorage.getItem("peserta")) || [];
                peserta.splice(index, 1);
                localStorage.setItem("peserta", JSON.stringify(peserta));
                tampilkanData();
            }

        });

        // Mapping Nama Kategori ke Kode
        const kategoriKodeMap = {
            "Pidato": "PDT",
            "Kaligrafi": "KLG",
            "Nasyid": "NSD",
            "Vlog": "VLG",
            "Poster": "PST",
            "Essai": "ESS"
        };

        // Counter per kode
        let counters = {
            PDT: 1,
            KLG: 1,
            NSD: 1,
            VLG: 1,
            PST: 1,
            ESS: 1
        };

        document.getElementById("kategori").addEventListener("change", function () {

            let namaKategori = this.value;

            if (!namaKategori) {
                document.getElementById("nomor").value = "";
                return;
            }

            let kode = kategoriKodeMap[namaKategori];

            // Ambil data peserta dari localStorage
            let data = JSON.parse(localStorage.getItem("peserta")) || [];

            // Hitung jumlah peserta dengan kategori yang sama
            let jumlahKategori = data.filter(item =>
                item.kategori === namaKategori
            ).length;

            // Nomor berikutnya
            let nomorUrut = String(jumlahKategori + 1).padStart(3, '0');

            document.getElementById("nomor").value = `${kode}-${nomorUrut}`;
        });


        async function downloadPDF() {
            const { jsPDF } = window.jspdf;

            if (!jsPDF) {
                alert("Library jsPDF belum dimuat!");
                return;
            }

            const doc = new jsPDF("landscape", "mm", "a4");

            let peserta = JSON.parse(localStorage.getItem("peserta")) || [];

            if (peserta.length === 0) {
                alert("Data peserta masih kosong!");
                return;
            }

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // ================= HEADER =================
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text("DAFTAR PESERTA", pageWidth / 2, 20, { align: "center" });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            doc.text("SERBU RAMADAN 2026", pageWidth / 2, 27, { align: "center" });

            // ================= DATA TABEL =================
            let tableData = peserta.map((p, index) => [
                index + 1,
                p.nomor || "-",
                p.nama || "-",
                p.pangkalan || "-",
                p.kwarran || "-",
                p.kategori || "-",
                ""
            ]);

            const marginSide = 20;
            const tableWidth = pageWidth - (marginSide * 2);

            if (typeof doc.autoTable !== "function") {
                alert("Plugin autoTable belum dimuat!");
                return;
            }

            doc.autoTable({
                startY: 35,
                margin: { left: marginSide, right: marginSide },
                tableWidth: tableWidth,
                head: [[
                    "No",
                    "Nomor Peserta",
                    "Nama Peserta",
                    "Pangkalan",
                    "Kwarran",
                    "Kategori",
                    "Tanda Tangan"
                ]],
                body: tableData,
                theme: "grid",
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    lineColor: [0, 0, 0],
                    lineWidth: 0.3,
                    minCellHeight: 8,
                    valign: "middle"
                },
                headStyles: {
                    fontStyle: "bold",
                    halign: "center",
                    fillColor: false,
                    textColor: 0
                },
                columnStyles: {
                    0: { halign: "center", cellWidth: 10 },
                    6: { cellWidth: 30 } // kolom tanda tangan lebih lebar
                }
            });

            // ================= POSISI AKHIR TABEL =================
            let finalY = doc.lastAutoTable?.finalY || 35;

            // Jika terlalu mepet bawah halaman, buat halaman baru
            if (finalY + 50 > pageHeight) {
                doc.addPage();
                finalY = 20;
            }

            // ================= TANDA TANGAN PANITIA =================
            const lokasiTanggal = "Garut, " + new Date().toLocaleDateString("id-ID", {
                day: "2-digit",
                month: "long",
                year: "numeric"
            });

            const jabatan = "Panitia Serbu Ramadhan";
            const rightX = pageWidth - 20;

            doc.setFontSize(11);
            doc.text(lokasiTanggal, rightX, finalY + 20, { align: "right" });
            doc.text(jabatan, rightX, finalY + 27, { align: "right" });
            doc.text("( _____________________ )", rightX, finalY + 55, { align: "right" });

            // ================= FOOTER =================
            doc.setFontSize(9);
            doc.text(
                "Dicetak pada: " + new Date().toLocaleString(),
                15,
                pageHeight - 10
            );

            doc.save("Daftar Peserta Serbu Ramadhan 2026.pdf");
        }

        document.addEventListener("DOMContentLoaded", function () {

            const radios = document.querySelectorAll('input[name="filter"]');
            const tbody = document.getElementById("tabelPeserta");

            let dataPeserta = JSON.parse(localStorage.getItem("peserta")) || [];

            // ===============================
            // RENDER TABLE
            // ===============================
            function renderTable(data) {
                tbody.innerHTML = "";

                data.forEach((item, index) => {

                    // cari index asli di localStorage
                    const indexAsli = dataPeserta.indexOf(item);

                    let row = `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td>${item.nomor}</td>
                    <td>${item.nama}</td>
                    <td>${item.jk}</td>
                    <td>${item.pangkalan}</td>
                    <td>${item.kwarran}</td>
                    <td>${item.kategori}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning me-1" onclick="editData(${index})">
                                <i class="bi bi-pencil"></i>
                            </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusPeserta(${indexAsli})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
                    tbody.innerHTML += row;
                });
            }

            // ===============================
            // FILTER
            // ===============================
            function filterData(kategoriDipilih) {
                if (kategoriDipilih === "Semua") {
                    renderTable(dataPeserta);
                } else {
                    const hasilFilter = dataPeserta.filter(item =>
                        item.kategori.toLowerCase() === kategoriDipilih.toLowerCase()
                    );
                    renderTable(hasilFilter);
                }
            }

            radios.forEach(radio => {
                radio.addEventListener("change", function () {
                    const labelText = document
                        .querySelector('label[for="' + this.id + '"]')
                        .innerText
                        .trim();

                    filterData(labelText);
                });
            });

            renderTable(dataPeserta);

        });

        // ===============================
        // HAPUS
        // ===============================
        function hapusPeserta(index) {
            let data = JSON.parse(localStorage.getItem("peserta")) || [];

            if (confirm("Yakin ingin menghapus peserta ini?")) {
                data.splice(index, 1);
                localStorage.setItem("peserta", JSON.stringify(data));
                location.reload();
            }
        }
    </script>
</body>

</html>