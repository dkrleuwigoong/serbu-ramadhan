<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voting - Serbu Ramadhan</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background:
                linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
                url("assets/img/background.png") no-repeat center center;
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            color: white;
        }



        .header-date {
            text-align: center;
            opacity: 0.9;
            margin-top: 20px;
            font-size: 14px;
        }

        .main-title {
            text-align: center;
            margin-top: 10px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .sub-title {
            text-align: center;
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .card-section {
            background: white;
            color: #333;
            border-radius: 18px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .form-select {
            border-radius: 10px;
        }

        .peserta-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            border: 2px solid transparent;
        }

        .peserta-card:hover {
            background: #eef5ff;
        }

        .peserta-card.active {
            border-color: #28a745;
            background: #eafaf1;
        }

        .submit-btn {
            background: linear-gradient(45deg, #ff8c00, #ff6a00);
            border: none;
            border-radius: 12px;
            padding: 12px;
            font-weight: 600;
            color: white;
            width: 100%;
            margin-top: 15px;
            transition: 0.2s;
        }

        .submit-btn:hover {
            transform: scale(1.02);
        }

        .btn-logout {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: #ff4d4d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: 0.2s ease-in-out;
        }

        .btn-logout:hover {
            background: #ff4d4d;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.4);
        }

        .modal-dialog {
            display: flex;
            align-items: center;
            min-height: 100vh;
        }

        .modal-content {
            border-radius: 16px;
        }
    </style>

</head>

<body>

    <div class="header-date">
        <script>
            document.write(new Date().toLocaleDateString("en-US", {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }));
        </script>
    </div>

    <h2 class="main-title">PEMILIHAN PESERTA LOMBA</h2>
    <div class="sub-title">
        PILIH KATEGORI & NAMA PESERTA FAVORIT ANDA
    </div>

    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">

                <div class="card-section">
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn-logout" data-bs-toggle="modal" data-bs-target="#modalLogout" title="Logout">
                            <i class="bi bi-box-arrow-right"></i>
                        </button>
                    </div>


                    <!-- PILIH KATEGORI -->
                    <div class="section-title">1. PILIH KATEGORI LOMBA</div>

                    <select id="kategoriSelect" class="form-select mb-4" onchange="pilihKategori(this.value)">
                        <option value="">Pilih Kategori</option>
                    </select>

                    <!-- PILIH PESERTA -->
                    <div class="section-title">2. PILIH NAMA PESERTA</div>

                    <div id="listPeserta"></div>

                    <button class="submit-btn" onclick="submitVote()">
                        SUBMIT PILIHAN
                    </button>

                    <div id="pesan" class="text-danger text-center mt-3 small"></div>

                </div>

            </div>
        </div>
    </div>
    <!-- Modal Logout -->
    <div class="modal fade" id="modalLogout" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow">

                <div class="modal-body text-center p-4">

                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 50px;"></i>
                    </div>

                    <h5 class="fw-semibold mb-2">Konfirmasi Logout</h5>
                    <p class="text-muted small mb-4">
                        Apakah Anda yakin ingin keluar dari halaman voting?
                    </p>

                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-light px-4" data-bs-dismiss="modal">
                            Batal
                        </button>

                        <button class="btn btn-danger px-4" onclick="logout()">
                            Ya, Logout
                        </button>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let kategoriDipilih = null;
        let pesertaDipilih = null;

        // Cek login
        const kodeAktif = localStorage.getItem("kodeAktif");
        if (!kodeAktif) {
            window.location.href = "index.html";
        }

        // Ambil data
        const dataPeserta = JSON.parse(localStorage.getItem("peserta")) || [];
        const kategoriSelect = document.getElementById("kategoriSelect");
        const pesan = document.getElementById("pesan");

        // Ambil kategori unik
        const kategoriUnik = [...new Set(dataPeserta.map(p => p.kategori))];

        // Isi dropdown kategori
        kategoriUnik.forEach(kat => {
            kategoriSelect.innerHTML += `<option value="${kat}">${kat}</option>`;
        });

        // Saat kategori dipilih
        function pilihKategori(kategori) {
            console.log("Kategori dipilih:", kategori);

            kategoriDipilih = kategori;
            pesertaDipilih = null;
            listPeserta.innerHTML = "";

            const filter = dataPeserta.filter(p => p.kategori == kategori);

            console.log("Peserta ditemukan:", filter);

            if (filter.length === 0) {
                listPeserta.innerHTML =
                    `<div class="text-muted small">Belum ada peserta di kategori ini</div>`;
                return;
            }

            filter.forEach(p => {
                listPeserta.innerHTML += `
            <div class="peserta-card"
                 onclick="pilihPeserta(this, '${p.nama}')">
                <div>${p.nomor || ''} - ${p.nama}</div>
                <i class="bi bi-check-circle-fill text-success d-none"></i>
            </div>
        `;
            });
        }

        // Saat peserta dipilih
        function pilihPeserta(element, nama) {
            pesertaDipilih = nama;

            document.querySelectorAll(".peserta-card").forEach(card => {
                card.classList.remove("active");
                card.querySelector("i").classList.add("d-none");
            });

            element.classList.add("active");
            element.querySelector("i").classList.remove("d-none");
        }

        // Submit vote
        function submitVote() {

            if (!kategoriDipilih || !pesertaDipilih) {
                pesan.innerText = "Silakan pilih kategori dan peserta!";
                return;
            }

            let kodeVoting = JSON.parse(localStorage.getItem("kodeVoting")) || [];
            let deviceId = localStorage.getItem("deviceId");

            // Generate device ID jika belum ada
            if (!deviceId) {
                deviceId = "DEV-" + Math.random().toString(36).substring(2, 8);
                localStorage.setItem("deviceId", deviceId);
            }

            const index = kodeVoting.findIndex(k => k.kode === kodeAktif);

            if (index === -1) {
                alert("Kode tidak valid!");
                return;
            }

            if (kodeVoting[index].status === "Sudah Dipakai") {
                alert("Kode sudah digunakan!");
                window.location.href = "index.html";
                return;
            }

            // Simpan hasil vote
            kodeVoting[index].status = "Sudah Dipakai";
            kodeVoting[index].deviceId = deviceId;
            kodeVoting[index].kategori = kategoriDipilih;
            kodeVoting[index].peserta = pesertaDipilih;

            localStorage.setItem("kodeVoting", JSON.stringify(kodeVoting));

            localStorage.removeItem("kodeAktif");

            window.location.href = "sukses.html";
        }

        function logout() {
            localStorage.removeItem("kodeAktif");
            window.location.href = "index.html";
        }


    </script>
</body>

</html>